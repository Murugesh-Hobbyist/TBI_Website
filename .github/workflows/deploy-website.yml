name: Deploy Website

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Select deployment target
        id: target
        shell: bash
        env:
          DEPLOY_WEBHOOK_URL: ${{ secrets.DEPLOY_WEBHOOK_URL }}
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          DEPLOY_SSH_PATH: ${{ secrets.DEPLOY_SSH_PATH }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_SSH_PASSWORD: ${{ secrets.DEPLOY_SSH_PASSWORD }}
          DEPLOY_FTP_SERVER: ${{ secrets.DEPLOY_FTP_SERVER }}
          DEPLOY_FTP_USERNAME: ${{ secrets.DEPLOY_FTP_USERNAME }}
          DEPLOY_FTP_PASSWORD: ${{ secrets.DEPLOY_FTP_PASSWORD }}
          DEPLOY_FTP_SERVER_DIR: ${{ secrets.DEPLOY_FTP_SERVER_DIR }}
        run: |
          if [ -n "$DEPLOY_WEBHOOK_URL" ]; then
            echo "mode=webhook" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -n "$DEPLOY_SSH_HOST" ] && [ -n "$DEPLOY_SSH_USER" ] && [ -n "$DEPLOY_SSH_PATH" ] && { [ -n "$DEPLOY_SSH_KEY" ] || [ -n "$DEPLOY_SSH_PASSWORD" ]; }; then
            echo "mode=ssh" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -n "$DEPLOY_FTP_SERVER" ] && [ -n "$DEPLOY_FTP_USERNAME" ] && [ -n "$DEPLOY_FTP_PASSWORD" ] && [ -n "$DEPLOY_FTP_SERVER_DIR" ]; then
            echo "mode=ftp" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "No deployment target configured."
          echo "Set one of: DEPLOY_WEBHOOK_URL, DEPLOY_SSH_* or DEPLOY_FTP_* repository secrets."
          exit 1

      - name: Trigger deployment webhook
        if: ${{ steps.target.outputs.mode == 'webhook' }}
        shell: bash
        env:
          DEPLOY_WEBHOOK_URL: ${{ secrets.DEPLOY_WEBHOOK_URL }}
          DEPLOY_WEBHOOK_TOKEN: ${{ secrets.DEPLOY_WEBHOOK_TOKEN }}
        run: |
          if [ -n "$DEPLOY_WEBHOOK_TOKEN" ]; then
            curl --fail --show-error --silent -X POST \
              -H "Authorization: Bearer $DEPLOY_WEBHOOK_TOKEN" \
              "$DEPLOY_WEBHOOK_URL"
          else
            curl --fail --show-error --silent -X POST "$DEPLOY_WEBHOOK_URL"
          fi

      - name: Deploy on server via SSH
        if: ${{ steps.target.outputs.mode == 'ssh' }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          password: ${{ secrets.DEPLOY_SSH_PASSWORD }}
          script_stop: true
          script: |
            set -e
            cd "${{ secrets.DEPLOY_SSH_PATH }}"
            git fetch origin main
            git checkout main
            git pull --ff-only origin main
            if [ -f artisan ]; then
              php artisan optimize:clear || true
            fi

      - name: Checkout
        if: ${{ steps.target.outputs.mode == 'ftp' }}
        uses: actions/checkout@v4

      - name: Sync via FTP
        if: ${{ steps.target.outputs.mode == 'ftp' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.DEPLOY_FTP_SERVER }}
          username: ${{ secrets.DEPLOY_FTP_USERNAME }}
          password: ${{ secrets.DEPLOY_FTP_PASSWORD }}
          local-dir: ./
          server-dir: ${{ secrets.DEPLOY_FTP_SERVER_DIR }}
          dangerous-clean-slate: false
